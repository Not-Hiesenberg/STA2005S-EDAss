---
title: "To Oil or Not to Oil: An Investigation into Agrabathi and Old Wive's Tales"
author: "Dhiya Tathiah and Keeran Moodley"
format:
  pdf:
    pdf-engine: latexmk
    latex-auto-install: true
    include-in-header:
      - file: preamble.tex
    toc: true
    number-sections: true
    colorlinks: true
execute: 
  echo: false
  eval: true
  output: false
filters:
  - parse-latex
---

```{r setup}
library(dplyr)
library(pastecs)
library(dplyr)
library(kableExtra)
library(car)

```

\newpage
# Introduction 
This assignment explores the influence of different oil treatments on the burn time of incense sticks through the application of a randomized block design (RBD). This study is structured around 3 distinct treatment types (..) randomly applied across 18 experimental units, with the incense brand serving as a blocking factor. By acknowledging the differences that might arise due to manufacturing or material quality, blocking for brands serves as a crucial step in isolating the true effects of the oil treatments. By structuring the experiment in this way, we aim to minimize the impact of confounding variables, allowing us to attribute any variations in burn time more confidently to the treatments themselves rather than to the intrinsic characteristics of the incense sticks.

# Motivation
There is an old wives tale which hails from the ancient Indian subcontinent and has been told for generations; applying oil to an incense stick will cause it to burn faster. This quick burn time ensured that the smoke created a sacred atmosphere, a well scented home and most importantly, carried your familyâ€™s prayers to the almighty deities above. While there can be no doubt about the role of incense sticks (or Agrabathi) in the cultural and spiritual settings of an Indian home, doubt remained about the effectiveness of dipping these sticks into the rich, often fragranced, oils. This study seeks to unravel the truth behind this age-old belief, offering modern families the wisdom to discern whether investing in extra oils for incense sticks truly enhances both their connection to the divine and the speed in which the fragrance emanates throughout their homes. By providing this knowledge, we aim to empower families to make informed decisions and potentially save them from unnecessary expenses if these treatments are found not to significantly extend the burn time of incense sticks.

# Objectives
Our objective is to determine which treatment has an effect on burn time looking at three treatment: a control, castor oil, and coconut oil. We will examine whether these commonly used oils differ from each other (comparison of castor and coconut oil)  and whether there is a difference with the oils from the control (comparing each oil individually to the control). By blocking for the different brands of incense sticks, we can more confidently deduce the differences between treatments, as the blocks contain homogeneous units. Once the incense sticks are lit and the smoke clears, the last burning stick will reveal whether oils truly influence burn time. By repeating this experiment three times, we ensure that our findings are as robust as the scent that lingers in the air.

Formally this study will test the following hypothesis:

::: {.callout-note appearance="simple"}
$H_0$: The application of different oils has no effect on the burn time of Agrabathi

$H_A$: The application of at least one of the oils has an effect on the burn time of Agrabathi
:::
Additionally the following two comparisons of means will be conducted:

::: {.callout-note appearance="simple"}
$L_1$: Effect of sandalwood oil is equal to the effect of coconut oil. 

$L_2$: The effect of no oil is equal to the average effect of applying the oils
:::
 

# Design and Procedure
This experiment will employ a randomised block design with a single factor - application of oil - of three levels, viz., control (no oil), coconut oil, and castor oil. The experiment will block for heterogeneity of experimental units arising from the use of different brands of Agrabathi viz., Hem, Malarani and Tulasi. The factor levels have been selected as they are oils commonly used in Indian households across the world and are the de facto choices during day to day use. The brands of Agrabathi from which the experimental units are drawn from represent easily found and widely exported brands. 

A pilot study will be conducted to assess the viability of the experimental procedure which is outlined below:

1. Select experimental units from each brand of Agrabathi
2. Randomly assign treatments to the units within each block
3. Apply the relevant treatment in the form of coating the sticks of Agrabathi in the appropriate oil ensuring that there is even and consistent covering
4. Light the Agrabathi sticks at their tip and place them in a sheltered area to burn
5. Record the time taken of the Agrabathi to completely burn

Precise details about the randomisation procedure will be discussed in \todo{Link to the relevant section}.

To reduce variance in the experiment due to external factors several steps will be taken to ensure that the experimental conditions will be kept consistent:

1. The Agrabathi will be burnt in the same area to prevent confounding due to location
2. The Agrabathi will be sheltered from wind and sunlight to prevent confounding due to increased airflow over the flaming tip and increased energy due to the sunlight
3. The blocks will be burnt at 10 minute intervals from each other to reduce confounding due to time. The interval is given to allow for the experimenters to set up and light the Agrabathi. This also allows for the majority of the Agrabathi in each group to burn concurrently to further reduce confounding due to time as well as increase the efficiency of the experiment.

 The response variable is the time taken for the Agrabathi to burn given in seconds. The measurement of this was achieved via online stopwatch websites and the data was then manually transcribed.

# Randomisation
Randomisation took place within each block of 3 experimental units (EUs). The procedure was as follows:

1. Label the EUs 1-3
2. Generate three random numbers between 1 and 1000 and iteratively assign them to the EUs (first generated number to EU 1, etc.)
3. Sort the random numbers in ascending order
4. Assign the treatments to the EUs using this ordered list, i.e., the EU corresponding to the lowest random number will be assigned the control treatment of no oil, the second number will get the coconut oil treatment and the largest number will get the castor oil treatment
5. Repeat 1-4 for all three blocks
6. Repeat 1-5 for every replication of the experiment

A sample randomisation for a singly replicated experiment is given below:

```{r}
#| output: true
#example randomisation

sampRand <-data.frame()

for (i in 1:3){
set.seed(sample(1:1000000))
randOrd<-sample(1:1000,3)
sorted<-sort(randOrd)
treat<-match(sorted,randOrd)
treat<-replace(treat, TRUE, LETTERS[unlist(treat)])
sampRand<- rbind(sampRand,treat)
}
colnames(sampRand)<-c(1,2,3)
rownames(sampRand)<-c("Hem", "Malarani" , "Tulasi")
kbl(sampRand, format="latex",booktabs=TRUE, caption="Sample Randomisation")|>
kable_styling(position = "center", latex_options="hold_position")
```
Where A,B, and C correspond to the treatment of no oil, coconut oil and castor oil respectively. The full randomisation used in given in the Appendix.


# Pilot study
The pilot study was run with 18 experimental units and blocks were replicated twice. 

Several difficulties were experienced while conducting the pilot study. Due to the large volume of smoke produced by the Agrabathi as it burnt, the experiment had to be conducted outdoors. This made it difficult to control for environmental factors such as wind, humidity, and sunlight. Additionally it was difficult to determine exactly when the Agrabathi stopped burning and thus there are slight non-systematic errors in the measurements of the burn times due to experimental error. 

The original data is provided in the appendix. A basic descriptive analysis was conducted to analyse the data:

```{r pilot data wrangling}
#Data wrangling and clean up
pilotBurn <- read.csv("AgrabathiBurnTimePilotData.csv")
pilotBurn$time <- pilotBurn$min*60+pilotBurn$sec
pilotBurn$min<- NULL
pilotBurn$sec <- NULL
pilotBurn$block <- factor(pilotBurn$block,levels=c(1,2,3), labels =c("Hem", "Malarani" , "Tulasi"))
pilotBurn$treat<- factor(pilotBurn$treat, levels=c("A","B","C"), labels=c("No oil", "Coconut oil", "Castor oil"))
```

```{r Descriptive stats}
#| output: true
#

descstats<-by(pilotBurn$time, pilotBurn$treat, stat.desc)
summaryData<- data.frame()
for (block in descstats){
  block<-unname(block)
  summaryData<-rbind(summaryData, data.frame(Median=block[8],Mean=block[9],SD=block[13]))
}
row.names(summaryData)<-c("Control", "Coconut Oil" , "Castor Oil")

kbl(summaryData,digits=2, format="latex",booktabs=TRUE, caption="Basic descriptive statistics")|>
kable_styling(position = "center", latex_options="hold_position")

```
The grand mean is `{r} round(mean(pilotBurn$time),2)` and grand sample standard deviation is `{r} round(sd(pilotBurn$time),2)`.
From Table 1, one notes some differences in the means across the three treatments. The control group shows the lowest mean burn time but displays the highest standard deviation out of all the treatments. This may be due to the heterogeneity of experimental units. The oil treatments show smaller standard deviations which may be indicative of a treatment effect. Additionally all three treatments display a positive skew. \todo{Check the skew dir}These insights suggest a need for more data to test for significant effects.

# Data collection and Assumptions
```{r}
# Data wrangling for generated data
genBurn <- read.csv("AgrabathiBurnTimeGeneratedData.csv")
genBurn$block<- as.integer(genBurn$block)

genBurn$block <- factor(genBurn$block,levels=c(1,2,3), labels =c("Hem", "Malarani" , "Tulasi"))
genBurn$treat<- factor(genBurn$treat, levels=c("A","B","C"), labels=c("No oil", "Coconut oil", "Castor oil"))

```


The full experiment was run with 30 replications per block. This took place using the same experimental and randomisation procedure as outlined above. The orginal data is given in the Appendix. Normality tests were then conducted to justify the assumptions which will be made (discussed in the next section) in the model. \todo{Add in all of Dhiya's analysis here and typeset}

```{r}
#| output: false
#| eval: false

par(mfrow=c(1,1))
boxplot(time ~ treat, data=genBurn, ylab="Burn Time (seconds)", xlab="Treatments", las=1, main="Boxplot of Experimental Data", col="pink")

treat<-as.factor(genBurn$treat)
treat

#Mainly estimates
model.tables(pilot,"means")#Gives the mean
model.tables(pilot, se=T)#Gives the standard error of effects

#Normality tests
par(mfrow=c(2,3))
plot(pilot)

hist(resid(pilot), main=" ", las=1, breaks=10)
shapiro.test(resid(pilot))

#Checking equal variance

with(genBurn, tapply(time, treat, sd))
#install.packages("car")

leveneTest(time ~ treat, data=genBurn) #Test for Homogeneity of Variances
#Levene's test evaluates whether the variances of different groups are significantly different from each other.
par(mfrow=c(1,2))
hist(genBurn$time, main="Histogram illustrating the distribution of burn times", las=1, xlab="Burn Time")
qqPlot(genBurn$time)

shapiro.test(genBurn$time)

```



# Model
This study will employ the following model for the data:
$$ Y_{ij}= \mu+ \alpha_i+ \beta_j+ \varepsilon_{ij} $$
Where $\varepsilon\sim N(0,\sigma^2)$ is the error term, $1\leq i\leq 3$ indexes the treatments, $1\leq j\leq 3$ indexes the blocks. Additionally we employ the corner point constraint such that $\alpha_1=0$. Additionally we assume an additive model and thus exclude the possibility of interaction between block and treatment effects.

This model will make the following assumptions:
1. Homoscedasticity
2. Normally distributed error terms
3. Independant observations

These assumptions are justified in the previous section as \todo{add in this stuff based on Dhiya's analysis}

# Outline of Analysis
\todo{Fluff up once we have actually done it}

# ANOVA
```{r}
anova<-aov(time~treat, data=genBurn)
summary(anova)
```

# Contrasts
This study examines 2 planned contrasts, viz., if there is a difference in the burn time of Agrabathi when no oil is applied versus when oil is applied and if there is difference in the burn time of Agrabathi when coconut oil is applied as opposed to castor oil.

To account for these comparisons this study sets a maximum allowable experiment-wise type I error rate of $5%$. The comparisons are then corrected via the Bonferroni method to ensure this limit is upheld.

Formally we consider the following contrasts:
\begin{align*}
  L_1&=\mu_{Coconut}-\mu_{Castor}\\
  L_2&=\mu_{No\ Oil}-\frac{1}{2}(\mu_{Coconut}+\mu_{Castor})
\end{align*}



# Conclusion
both thursday 12pm M202

\newpage
# Appendix 
The original randomisation used is given below:
```{r}
#| output: true
#example randomisation

sampRand <-data.frame()

for (j in 1:30){
  for (i in 1:3){
  set.seed(sample(1:1000000))
  randOrd<-sample(1:1000,3)
  sorted<-sort(randOrd)
  treat<-match(sorted,randOrd)
  treat<-replace(treat, TRUE, LETTERS[unlist(treat)])
  sampRand<- rbind(sampRand,treat)
  }
}

sampRand<-cbind(c(rep("Hem",30), rep("Malarani",30) , rep("Tulasi",30)),sampRand)
colnames(sampRand)<-c("Block",1,2,3)
sampRand<-sampRand[sample(nrow(sampRand)),]
rownames(sampRand)<- NULL
kbl(sampRand, format="latex",booktabs=TRUE, longtable= TRUE, caption="Randomisation within blocks", row.names=NA)|>
kable_styling(position = "center", latex_options="hold_position")
```
The full data (after sorting) for the experiment is given below:

```{r}
#| output: true

modGenBurn<-genBurn
modGenBurn$time<-round(modGenBurn$time,2)
kbl(genBurn, longtable = TRUE, format="latex",booktabs=TRUE, caption="Randomisation within blocks", row.names=NA)|>
kable_styling(position = "center", latex_options="hold_position")
```

```{r}
#| eval: false
#Generation of data
n<- 10 #number of replications witin block

blocks<- c(1,2,3)
treat<- c("A","B","C")
std<-sd(pilotBurn$time)

df<-data.frame()
#set up columns
for (i in 1:3){
  block<- rep(i, times=n)
  treatment<-rep(treat,c(n,n,n)) 
  df<-rbind(df,cbind(block,treatment)) 
}
#generate data
times<-c()
for (i in 1:3){ #block
  #get means for each treatment within block
  means<- aov(time~treat,data=filter(pilotBurn, as.integer(block)==i))|>
         model.tables("means")
  means<- unname(unlist(means)[2:4])
  for (meanval in means){
    times<-c(times,rnorm(n,mean=meanval,sd=std))
  }
}
df<-cbind(df,time=times)
write.csv(df,row.names=FALSE,file="gendata.csv")
```
```{r}
#The pilot study full code
#| output: false
#| eval: false
data_raw<-read.csv(file="AgrabathiBurnTimePilotData.csv")
par(mfrow=c(1,1))
boxplot(min*60+sec ~ treat, data=data_raw, ylab="Burn Time (seconds)", xlab="Treatments", las=1, main="Boxplot of Pilot Study Data", col="pink")
data_raw

treat<-as.factor(data_raw$treat)
treat

#Mainly estimates
pilot<-aov(min*60+sec ~ treat, data=data_raw)
summary(pilot)
model.tables(pilot,"means")#Gives the mean
model.tables(pilot, se=T)#Gives the standard error of effects

#Normality tests
par(mfrow=c(2,3))
plot(pilot)

hist(resid(pilot), main=" ", las=1, breaks=10)

shapiro.test(resid(pilot))

#Checking equal variance

with(data_raw, tapply(min*60+sec, treat, sd))
#install.packages("car")

burn_time<-data_raw$min*60 +data_raw$sec
burn_time
leveneTest(min*60 +sec ~ treat, data=data_raw) 
#Since p value is 0.7526, assumption of equal variances is met since variances are not sig different.
par(mfrow=c(1,2))
hist(burn_time, main="", las=1, xlab="Burn Time")
qqPlot(burn_time) #Does look like data came from the same theoretical normal distr.

shapiro.test(burn_time)

```
